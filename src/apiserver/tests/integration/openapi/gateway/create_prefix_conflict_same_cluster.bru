meta {
  name: create_gateway_prefix_conflict_same_cluster
  type: http
  seq: 10
}

post {
  url: {{scheme}}://{{host}}/api/v1/open/gateways/
}

body {
    {
      "name": "test-prefix-conflict",
      "description": "Test Gateway with prefix conflict",
      "mode": 1,
      "apisix_type": "bk-apisix",
      "apisix_version": "3.11.0",
      "etcd_endpoints": [
        "{{etcd_endpoints}}"
      ],
      "maintainers": [
        "admin"
      ],
      "etcd_prefix": "/apisix/sub",
      "etcd_schema_type": "http",
      "etcd_username": "{{etcd_username}}",
      "etcd_password": "{{etcd_password}}"
    }
}

headers {
  Content-Type: application/json
  X-BK-API-TOKEN: {{x_bk_api_token}}
}

tests {
  test("同一 etcd 集群创建有层级冲突的 prefix 应返回 400", function() {
    // 前置条件：已存在一个使用 /apisix 前缀的网关
    // 尝试创建使用 /apisix/sub 前缀的网关应该失败
    // 因为 /apisix 是 /apisix/sub 的父路径
    expect(res.status).to.equal(400);
  });

  test("错误信息应包含层级冲突提示", function() {
    const errorMsg = res.body.message || res.body.error?.message || "";
    expect(errorMsg).to.include("层级冲突");
  });
}
