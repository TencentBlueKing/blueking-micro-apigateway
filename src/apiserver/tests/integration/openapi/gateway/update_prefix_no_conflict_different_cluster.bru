meta {
  name: update_gateway_prefix_no_conflict_different_cluster
  type: http
  seq: 24
}

put {
  url: {{scheme}}://{{host}}/api/v1/open/gateways/test-update-conflict-gateway/
}

body {
    {
      "name": "test-update-conflict-gateway",
      "description": "Update with different etcd cluster allows same prefix hierarchy",
      "mode": 1,
      "apisix_type": "bk-apisix",
      "apisix_version": "3.11.0",
      "etcd_endpoints": [
        "{{etcd_endpoints_alt}}"
      ],
      "maintainers": [
        "admin"
      ],
      "etcd_prefix": "/apisix/sub",
      "etcd_schema_type": "http",
      "etcd_username": "{{etcd_username}}",
      "etcd_password": "{{etcd_password}}"
    }
}

headers {
  Content-Type: application/json
  X-BK-API-TOKEN: {{x_bk_api_token}}
}

tests {
  test("更新网关使用不同 etcd 集群允许层级关系的 prefix", function() {
    // 不同的 etcd 集群，即使 prefix 有层级关系也不应冲突
    // 注意：此测试需要配置 etcd_endpoints_alt 环境变量指向不同的 etcd 集群
    // 如果 etcd_endpoints_alt 未配置，会返回 400（地址格式错误）
    // 如果配置正确且连接成功，应返回 200（允许层级关系）
    // 如果配置正确但连接失败，会返回其他错误
    
    // 检查是否因为 prefix 冲突而失败（这是不应该发生的）
    if (res.status === 400) {
      const errorMsg = res.body.message || res.body.error?.message || "";
      // 确保不是因为 prefix 层级冲突失败
      expect(errorMsg).to.not.include("层级冲突");
    }
    // 如果环境变量配置正确，应该返回 200
    // 允许 200（成功）或 400（etcd 连接/配置问题，但不是 prefix 冲突）
    expect([200, 400]).to.include(res.status);
  });
}
